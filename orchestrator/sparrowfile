#!raku

use Sparky::JobApi;

class Pipeline

does Sparky::JobApi::Role

{

  method stage-main {

    "list.txt".IO.spurt(config()<list><>.join("\n"));

    Sparky::JobApi.new(:mine).put-file("list.txt","list.txt");

    my @eff-list = config()<list><>;
    
    my $agents-queue = Sparky::JobApi.new(:project<browny.queue>);

    my $j = 0;

    while ($j <= 200 || @eff-list.elems > 0) {
      my @_list = [];
      for @eff-list -> $l {
        if "/tmp/brownie/versions/2025.10/{$l}.OK".IO ~~ :f  ||
           "/tmp/brownie/versions/2025.10/{$l}.FAIL".IO ~~ :f  {
              next;
        }
        push @_list, $l;
      }
      @eff-list = @_list;        
      my $chunk = 0;
      my @agents;
      my $k = 0;

      while ($k < 10 or @agents.elems == 0) {
        say "look for available agents ...";    
        if "/tmp/brownie/agents".IO ~~ :d { 
          for dir("/tmp/brownie/agents") {
              push @agents, $_.basename;
          }
        }
        say " ... $k";
        sleep(1);
        $k++;
      }

      # remove agents that don't respond more then 10 minutes
      
      if "/tmp/brownie/agents".IO ~~ :d {
        bash "find /tmp/brownie/agents -type f -mmin +10 -delete";
      }

      say "{@agents.elems} online agents found";

      if @agents.elems > 0 && @eff-list.elems > 0 {
        if @eff-list.elems < @agents.elems {
            $chunk = 1;
            @agents = @agents[0 .. @eff-list.elems -1];
        } else {
          $chunk = Int(@eff-list.elems/@agents.elems);
          $chunk = 3 if $chunk > 3;
        }
      } else {
        sleep(10);
      }

      if @agents > 0 && @eff-list.elems > 0 {

        my $a = 0;

        say "agents cnt: {@agents.elems}";

        say "chunk: $chunk";

        for 1 .. @agents.elems -> $i {

          my @slice = @eff-list[$a .. $a + $chunk - 1];

          @slice = @slice.sort;
          say "push job to agent {@agents[$i-1]}";
          $agents-queue.put-stash(
            %( 
              version => "2025.10",
              agent => @agents[$i-1],
              modules => @slice,
            )
          );
          say "slice: {@slice.raku}";
          $a = $a + $chunk;
          say "===";
        }
        sleep(10);
        $j++;
      }
    }
  }

}  

Pipeline.new.run;